services:
  # MongoDB Service
  mongodb:
    image: mongo:7.0
    container_name: job-portal-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - job-portal-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: job-portal-redis
    restart: unless-stopped
    ports:
      - '6379:6379' # Mở port 6379 ra máy host của bạn (tiện cho việc debug)
    volumes:
      - redis_data:/data # Volume để lưu trữ dữ liệu Redis
    networks:
      - job-portal-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # NestJS Backend Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: ${NODE_ENV:-development}
    container_name: job-portal-backend
    restart: unless-stopped
    ports:
      - '${PORT:-8081}:${PORT:-8081}'
    environment:
      - PORT=${PORT:-8081}
      - MONGO_URL=mongodb://root:123456@mongodb:27017/my-job-portal?authSource=admin
      - NODE_ENV=${NODE_ENV:-development}
      - JWT_ACCESS_TOKEN_SECRET=${JWT_ACCESS_TOKEN_SECRET}
      - JWT_ACCESS_EXPIRES_IN=${JWT_ACCESS_EXPIRES_IN}
      - JWT_REFRESH_TOKEN_SECRET=${JWT_REFRESH_TOKEN_SECRET}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}
      - EMAIL_ADMIN=${EMAIL_ADMIN}
      - INIT_PASSWORD=${INIT_PASSWORD}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_EMAIL=${SMTP_EMAIL}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - REDIS_HOST=redis # Trỏ đến tên service "redis"
      - REDIS_PORT=6379
      - REDIS_QUEUE_DB=0 # Database cho BullMQ
      - REDIS_CACHE_DB=1 # Database cho Cache
    volumes:
      # Mount source code for development hot-reload
      - .:/app
      - /app/node_modules
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - job-portal-network
    command: npm run start:dev

networks:
  job-portal-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
